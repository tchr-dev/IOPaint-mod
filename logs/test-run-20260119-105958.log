Running: uv run pytest -k "openai" -v
---
============================= test session starts ==============================
platform darwin -- Python 3.12.10, pytest-9.0.2, pluggy-1.6.0 -- /Users/ikovale/Dev/IOPaint-mod/.venv/bin/python3
cachedir: .pytest_cache
rootdir: /Users/ikovale/Dev/IOPaint-mod
configfile: pyproject.toml
plugins: anyio-4.12.1, loguru-0.4.0
collecting ... collected 312 items / 287 deselected / 25 selected

iopaint/tests/test_api_error_handling.py::TestModelSwitchingErrorHandling::test_switch_to_openai_without_api_key PASSED [  4%]
iopaint/tests/test_openai_capabilities.py::test_capabilities_normalization PASSED [  8%]
iopaint/tests/test_openai_client.py::test_list_models_parses_response PASSED [ 12%]
iopaint/tests/test_openai_client.py::test_generate_image_uses_b64_payload PASSED [ 16%]
iopaint/tests/test_openai_client.py::test_refine_prompt_returns_content PASSED [ 20%]
iopaint/tests/test_openai_client.py::test_list_models_raises_openai_error PASSED [ 24%]
iopaint/tests/test_openai_errors.py::test_classify_error_rate_limit PASSED [ 28%]
iopaint/tests/test_openai_errors.py::test_classify_error_quota PASSED    [ 32%]
iopaint/tests/test_openai_errors.py::test_classify_error_content_policy PASSED [ 36%]
iopaint/tests/test_openai_errors.py::test_classify_error_server_error PASSED [ 40%]
iopaint/tests/test_openai_errors.py::test_create_timeout_and_network_errors PASSED [ 44%]
iopaint/tests/test_openai_protocol_integration.py::test_openai_protocol_generate_creates_history PASSED [ 48%]
iopaint/tests/test_openai_protocol_integration.py::test_openai_protocol_generate_dedupe PASSED [ 52%]
iopaint/tests/test_openai_protocol_integration.py::test_openai_protocol_edit_creates_history PASSED [ 56%]
iopaint/tests/test_openai_protocol_integration.py::test_openai_protocol_budget_block PASSED [ 60%]
iopaint/tests/test_openai_tools_api.py::test_openai_upscale_prompt_uses_edit PASSED [ 64%]
iopaint/tests/test_openai_tools_api.py::test_openai_outpaint_uses_edit FAILED [ 68%]
iopaint/tests/test_openai_tools_api.py::test_openai_upscale_invalid_mode PASSED [ 72%]
iopaint/tests/test_openai_tools_api.py::test_openai_background_remove_service_unconfigured PASSED [ 76%]
iopaint/tests/test_openai_tools_api.py::test_openai_background_remove_prompt_uses_edit PASSED [ 80%]
iopaint/tests/test_openai_tools_api.py::test_openai_variations_with_dummy_client PASSED [ 84%]
iopaint/tests/test_openai_tools_api.py::test_openai_invalid_base_url PASSED [ 88%]
iopaint/tests/test_openai_tools_api.py::test_openai_jobs_submit_and_get PASSED [ 92%]
iopaint/tests/test_openai_tools_api.py::test_openai_jobs_cancel PASSED   [ 96%]
iopaint/tests/test_openai_tools_api.py::test_openai_jobs_persist_inputs PASSED [100%]

=================================== FAILURES ===================================
________________________ test_openai_outpaint_uses_edit ________________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x131d31850>
tmp_path = PosixPath('/private/var/folders/6c/p3d8vbkj14j3s24cbg1btls00000gn/T/pytest-of-ikovale/pytest-12/test_openai_outpaint_uses_edit0')

    def test_openai_outpaint_uses_edit(monkeypatch, tmp_path):
        client, api = _make_test_client(monkeypatch, tmp_path, with_openai=True)
        image_bytes = _make_png_bytes()
        mask_bytes = _make_png_bytes(color=(0, 0, 0))
    
        res = client.post(
            "/api/v1/openai/outpaint",
            data={"prompt": "Extend the background"},
            files={
                "image": ("image.png", image_bytes, "image/png"),
                "mask": ("mask.png", mask_bytes, "image/png"),
            },
        )
    
>       assert res.status_code == 200
E       assert 500 == 200
E        +  where 500 = <Response [500 Internal Server Error]>.status_code

iopaint/tests/test_openai_tools_api.py:148: AssertionError
----------------------------- Captured stderr call -----------------------------
2026-01-19 11:00:03.821 | INFO     | iopaint.api:__init__:237 - OpenAI-compatible client enabled: https://api.openai.com/v1
2026-01-19 11:00:03.823 | INFO     | iopaint.api:__init__:244 - Budget safety enabled: BudgetConfig(daily_cap=$10.00, monthly_cap=$100.00, session_cap=$5.00, rate_limit=10s, dedupe=True)
2026-01-19 11:00:03.826 | INFO     | iopaint.api:__init__:266 - Storage initialized: /private/var/folders/6c/p3d8vbkj14j3s24cbg1btls00000gn/T/pytest-of-ikovale/pytest-12/test_openai_outpaint_uses_edit0/data
Traceback (most recent call last):
  File "/Users/ikovale/Dev/IOPaint-mod/iopaint/api.py", line 183, in exception_handling
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ikovale/Dev/IOPaint-mod/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 168, in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
  File "/Users/ikovale/Dev/IOPaint-mod/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/ikovale/Dev/IOPaint-mod/.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/Users/ikovale/Dev/IOPaint-mod/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/ikovale/Dev/IOPaint-mod/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/ikovale/Dev/IOPaint-mod/.venv/lib/python3.12/site-packages/fastapi/middleware/asyncexitstack.py", line 18, in __call__
    await self.app(scope, receive, send)
  File "/Users/ikovale/Dev/IOPaint-mod/.venv/lib/python3.12/site-packages/starlette/routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/ikovale/Dev/IOPaint-mod/.venv/lib/python3.12/site-packages/starlette/routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "/Users/ikovale/Dev/IOPaint-mod/.venv/lib/python3.12/site-packages/starlette/routing.py", line 290, in handle
    await self.app(scope, receive, send)
  File "/Users/ikovale/Dev/IOPaint-mod/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 115, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/Users/ikovale/Dev/IOPaint-mod/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/ikovale/Dev/IOPaint-mod/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/ikovale/Dev/IOPaint-mod/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 101, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Users/ikovale/Dev/IOPaint-mod/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 355, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ikovale/Dev/IOPaint-mod/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 245, in run_endpoint_function
    return await run_in_threadpool(dependant.call, **values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ikovale/Dev/IOPaint-mod/.venv/lib/python3.12/site-packages/starlette/concurrency.py", line 32, in run_in_threadpool
    return await anyio.to_thread.run_sync(func)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ikovale/Dev/IOPaint-mod/.venv/lib/python3.12/site-packages/anyio/to_thread.py", line 63, in run_sync
    return await get_async_backend().run_sync_in_worker_thread(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ikovale/Dev/IOPaint-mod/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 2502, in run_sync_in_worker_thread
    return await future
           ^^^^^^^^^^^^
  File "/Users/ikovale/Dev/IOPaint-mod/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 986, in run
    result = context.run(func, *args)
             ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ikovale/Dev/IOPaint-mod/iopaint/api.py", line 909, in api_openai_outpaint
    return self.api_openai_edit(
           ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ikovale/Dev/IOPaint-mod/iopaint/api.py", line 815, in api_openai_edit
    self._record_openai_image_job(
  File "/Users/ikovale/Dev/IOPaint-mod/iopaint/api.py", line 1073, in _record_openai_image_job
    image_record = self.image_storage.save_image(image_bytes, job_id=stored_job.id)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ikovale/Dev/IOPaint-mod/iopaint/storage/images.py", line 94, in save_image
    img = Image.open(BytesIO(image_data))
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ikovale/Dev/IOPaint-mod/.venv/lib/python3.12/site-packages/PIL/Image.py", line 3579, in open
    raise UnidentifiedImageError(msg)
PIL.UnidentifiedImageError: cannot identify image file <_io.BytesIO object at 0x131dd9b20>
=============================== warnings summary ===============================
iopaint/helper.py:2
  /Users/ikovale/Dev/IOPaint-mod/iopaint/helper.py:2: DeprecationWarning: 'imghdr' is deprecated and slated for removal in Python 3.13
    import imghdr

iopaint/schema.py:426
  /Users/ikovale/Dev/IOPaint-mod/iopaint/schema.py:426: PydanticDeprecatedSince212: Using `@model_validator` with mode='after' on a classmethod is deprecated. Instead, use an instance method. See the documentation at https://docs.pydantic.dev/2.12/concepts/validators/#model-after-validator. Deprecated in Pydantic V2.12 to be removed in V3.0.
    @model_validator(mode="after")

iopaint/storage/models.py:57
  /Users/ikovale/Dev/IOPaint-mod/iopaint/storage/models.py:57: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class GenerationJob(BaseModel):

iopaint/storage/models.py:85
  /Users/ikovale/Dev/IOPaint-mod/iopaint/storage/models.py:85: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class ImageRecord(BaseModel):

iopaint/storage/models.py:106
  /Users/ikovale/Dev/IOPaint-mod/iopaint/storage/models.py:106: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class HistorySnapshot(BaseModel):

iopaint/tests/test_openai_protocol_integration.py::test_openai_protocol_generate_creates_history
iopaint/tests/test_openai_protocol_integration.py::test_openai_protocol_generate_dedupe
iopaint/tests/test_openai_protocol_integration.py::test_openai_protocol_generate_dedupe
iopaint/tests/test_openai_protocol_integration.py::test_openai_protocol_edit_creates_history
  /Users/ikovale/Dev/IOPaint-mod/iopaint/budget/storage.py:437: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    now = datetime.utcnow()

iopaint/tests/test_openai_protocol_integration.py::test_openai_protocol_generate_creates_history
iopaint/tests/test_openai_protocol_integration.py::test_openai_protocol_generate_dedupe
iopaint/tests/test_openai_protocol_integration.py::test_openai_protocol_edit_creates_history
  /Users/ikovale/Dev/IOPaint-mod/iopaint/budget/storage.py:334: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    today_start = datetime.utcnow().replace(hour=0, minute=0, second=0, microsecond=0)

iopaint/tests/test_openai_protocol_integration.py::test_openai_protocol_generate_creates_history
iopaint/tests/test_openai_protocol_integration.py::test_openai_protocol_generate_dedupe
iopaint/tests/test_openai_protocol_integration.py::test_openai_protocol_edit_creates_history
  /Users/ikovale/Dev/IOPaint-mod/iopaint/budget/storage.py:360: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    month_start = datetime.utcnow().replace(day=1, hour=0, minute=0, second=0, microsecond=0)

iopaint/tests/test_openai_protocol_integration.py::test_openai_protocol_generate_creates_history
iopaint/tests/test_openai_protocol_integration.py::test_openai_protocol_generate_dedupe
iopaint/tests/test_openai_protocol_integration.py::test_openai_protocol_edit_creates_history
iopaint/tests/test_openai_protocol_integration.py::test_openai_protocol_budget_block
  /Users/ikovale/Dev/IOPaint-mod/iopaint/budget/storage.py:421: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    now = datetime.utcnow()

iopaint/tests/test_openai_protocol_integration.py::test_openai_protocol_generate_creates_history
iopaint/tests/test_openai_protocol_integration.py::test_openai_protocol_generate_dedupe
iopaint/tests/test_openai_protocol_integration.py::test_openai_protocol_edit_creates_history
  /Users/ikovale/Dev/IOPaint-mod/iopaint/budget/storage.py:463: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    expires_at = datetime.utcnow() + timedelta(seconds=ttl)

iopaint/tests/test_openai_protocol_integration.py::test_openai_protocol_generate_creates_history
iopaint/tests/test_openai_protocol_integration.py::test_openai_protocol_generate_dedupe
iopaint/tests/test_openai_protocol_integration.py::test_openai_protocol_generate_dedupe
iopaint/tests/test_openai_protocol_integration.py::test_openai_protocol_edit_creates_history
iopaint/tests/test_openai_protocol_integration.py::test_openai_protocol_budget_block
iopaint/tests/test_openai_tools_api.py::test_openai_outpaint_uses_edit
iopaint/tests/test_openai_tools_api.py::test_openai_jobs_submit_and_get
iopaint/tests/test_openai_tools_api.py::test_openai_jobs_cancel
iopaint/tests/test_openai_tools_api.py::test_openai_jobs_persist_inputs
  /Users/ikovale/Dev/IOPaint-mod/iopaint/storage/history.py:261: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    now = datetime.utcnow()

iopaint/tests/test_openai_protocol_integration.py::test_openai_protocol_generate_creates_history
iopaint/tests/test_openai_protocol_integration.py::test_openai_protocol_generate_dedupe
iopaint/tests/test_openai_protocol_integration.py::test_openai_protocol_generate_dedupe
iopaint/tests/test_openai_protocol_integration.py::test_openai_protocol_edit_creates_history
iopaint/tests/test_openai_protocol_integration.py::test_openai_protocol_budget_block
  /Users/ikovale/Dev/IOPaint-mod/iopaint/storage/images.py:116: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    now = datetime.utcnow()

iopaint/tests/test_openai_protocol_integration.py::test_openai_protocol_generate_creates_history
iopaint/tests/test_openai_protocol_integration.py::test_openai_protocol_generate_dedupe
iopaint/tests/test_openai_protocol_integration.py::test_openai_protocol_generate_dedupe
iopaint/tests/test_openai_protocol_integration.py::test_openai_protocol_edit_creates_history
iopaint/tests/test_openai_protocol_integration.py::test_openai_protocol_budget_block
iopaint/tests/test_openai_tools_api.py::test_openai_jobs_cancel
  /Users/ikovale/Dev/IOPaint-mod/iopaint/storage/history.py:327: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    params.append(datetime.utcnow().isoformat())

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED iopaint/tests/test_openai_tools_api.py::test_openai_outpaint_uses_edit
========== 1 failed, 24 passed, 287 deselected, 42 warnings in 5.53s ===========
---
Command failed with status 1
